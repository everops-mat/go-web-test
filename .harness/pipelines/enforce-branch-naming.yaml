---
pipeline:
  name: Enforce Branch Naming
  identifier: Enforce_Branch_Naming
  projectIdentifier: default_project
  orgIdentifier: default
  tags: {}
  properties:
    ci:
      codebase:
      connectorRef: account.Github_OAuth_1742571287290
      repoName: everops-mat/go-web-test
      build: <+input>
  stages:
    - stage:
        name: Validate Branch Name
        identifier: Validate_Branch_Name
        type: CI
        spec:
          cloneCodebase: true
          execution:
            steps:
              - step:
                  name: Get Branch Name and Validate
                  identifier: Branch_Name_Check
                  type: Run
                  spec:
                    shell: Bash
                    command: |
                      echo "Checking branch name..."

                      # Get the branch name
                      if [[ "$HARNESS_GIT_EVENT" == "pull_request" ]]; then
                        BRANCH_NAME="$HARNESS_GIT_PR_SOURCE_BRANCH"
                      else
                        BRANCH_NAME="$HARNESS_GIT_BRANCH"
                      fi

                      echo "Branch name: $BRANCH_NAME"

                      # Define allowed patterns
                      ALLOWED_BRANCH_PREFIXES="feature/* hotfix/* bugfix/* ci/* release/*"
                      REGEX=$(echo "$ALLOWED_BRANCH_PREFIXES" | sed -e 's/ /|/g' | sed -e 's/\*/[a-z0-9._-]*/g')

                      if [[ ! $BRANCH_NAME =~ ^($REGEX)$ ]]; then
                        echo "Branch name '$BRANCH_NAME' is invalid."
                        echo "Allowed branch prefixes: $ALLOWED_BRANCH_PREFIXES"
                        exit 1
                      fi

                      echo "Branch name $BRANCH_NAME is valid."
